## 第 3 章 虚拟机性能监控与故障处理工具

[toc]

### 3.1 JDK 的命令行工具

| 名称   | 主要作用                                                     |
| ------ | ------------------------------------------------------------ |
| jps    | JVM Process Status Tool，显示指定系统内所有的 HotSpot 虚拟机进程 |
| jstat  | JVM Statistics Monitoring Tool，用于收集 HotSpot 虚拟机各方面的运行数据 |
| jinfo  | Configuration Info for Java，显示虚拟机配置信息              |
| jmap   | Memory Map for Java，生成虚拟机的内存转储快照（heapdump 文件） |
| jhat   | JVM Heap Dump Browser，用于分析 heapdump 文件，它会建立一个 Http/HTML服务器，让用户可以在浏览器上查看分析结果 |
| jstack | Stack Trace for Java，显示虚拟机的线程快照                   |

- ***jps：虚拟机进程状况工具***

  **jps 命令格式**

  ​                                                                                                                                                                                                                                                                                                              jps [options] [hostid]

  | 选项 | 作用                                                         |
  | ---- | ------------------------------------------------------------ |
  | -q   | 值输出 LVMID（Local Virtual Machine Identifier，本地虚拟机唯一 ID），省略主类的名称 |
  | -m   | 输出虚拟机进程启动时传递给主类 main() 函数的参数             |
  | -l   | 输出主类的全名，如果进程执行的是 Jar 包，输出 Jar 路径       |
  | -v   | 输出虚拟机进程启动时 JVM 参数                                |

  jps 可以通过 RMI 协议查询开启了 RMI 服务的远程虚拟机服务进程状态，hostid 为 RMI 注册表中注册的主机名。

- ***jstat：虚拟机统计信息监视工具***

  **jstat 命令格式**

  jstat [option vmid [interval [s | ms] [count]]]

  > vmid 与 lvmid 说明：如果是本地虚拟机进程，vmid 与 lvmid 是一致的；如果是远程虚拟机进程，那 vmid 的格式应当是：
  >
  > **[protocol:] [//] lvmid [@hostname[:port]/servername]**

  参数 interval 和 count 代表查询间隔和次数，省略这两个参数，说明只查询一次。

  | 选项              | 作用                                                         |
  | ----------------- | ------------------------------------------------------------ |
  | -class            | 监视类装载、卸载数量、总空间以及类装载所消耗的时间           |
  | -gc               | 监视 Java 堆状况，包括 Eden 区、两个 Survivor 区、老年代、永久代的容量，已用空间、GC 时间合计等信息 |
  | -gccapacity       | 监视内容与 -gc 基本相同，但输出主要关注 Java 堆各个区域使用到的最大、最小空间 |
  | -gcutil           | 监视内容与 -gc 基本相同，但输出主要关注已使用空间占总空间的百分比 |
  | -gccause          | 与 -gcutil 功能一样，但是会额外输出导致上一次 GC 产生的原因  |
  | -gcnew            | 监视新生代 GC 状况                                           |
  | -gcnewcapacity    | 监视内容与 -gcnew 基本相同，输出主要关注使用到的最大、最小空间 |
  | -gcold            | 监视老年代 GC 状况                                           |
  | -gcoldcapacity    | 监视内容与 -gcold 基本相同，输出主要关注使用到的最大、最小空间 |
  | -gcpermcapacity   | 输出永久代使用到的最大、最小空间                             |
  | -compiler         | 输出 JIT 编译器过的方法、耗时等信息                          |
  | -printcompilation | 输出已经被 JIT 编译的方法                                    |

- ***jinfo：配置信息工具***

  **jinfo 命令格式**

  jinfo [option] pid

- ***jmap：Java 内存映像工具***

  **jmap 命令格式**

  jmap [option] vmid

  | 选项           | 作用                                                         |
  | -------------- | ------------------------------------------------------------ |
  | -dump          | 生成 Java 堆转储快照，格式为：-dump:[live, ]format=b, file=<filename>，其中 live 子参数说明是否只 dump 出存活的对象 |
  | -finalizerinfo | 显示在 F-Queue 中等待 Finalizer 线程执行 finalize() 方法的对象，只在 Linux/Solaris平台下有效 |
  | -heap          | 显示 Java 堆详细信息，如使用哪种回收器、参数配置、分代状况等，只在 Linux/Solaris平台下有效 |
  | -histo         | 显示堆中对象统计信息，包括类、实例数量、合计容量             |
  | -permstat      | 已 ClassLoader 为统计口径显示永久代内存状况，只在 Linux/Solaris平台下有效 |
  | -F             | 当虚拟机进程对 -dump 选项没有响应时，可使用这个选项强制生成 dump 快照，只在 Linux/Solaris平台下有效 |

- ***jstack：java 堆栈跟踪工具***，用于生成虚拟机当前时刻的线程快照

  **jstack 命令格式**

  jstack [option] vmid

  | 选项 | 作用                                         |
  | ---- | -------------------------------------------- |
  | -F   | 当正常输出的请求不被响应时，强制输出线程堆栈 |
  | -l   | 除堆栈外，显示关于锁的附加信息               |
  | -m   | 如果调用本地方法的话，可以显示 C/C++的堆栈   |

### 3.2 部分命令输出说明

#### 类加载统计 jstat -class 线程号
| Loaded          | Bytes          | Unloaded       | Bytes | Time |
| --------------- | -------------- | -------------- | ----- | ---- |
| 加载class的数量 | 所占用空间大小 | 未加载占用空间 |       | 时间 |

#### 编译统计 jstat -compiler 
| Compiled | Failed   | Invalid    | Time | FailedType | FailedMethod |
| -------- | -------- | ---------- | ---- | ---------- | ------------ |
| 编译数量 | 失败数量 | 不可用数量 | 时间 | 失败类型   | 失败的方法   |

#### 垃圾回收统计 jstat -gc
| S0C                | S1C                | S0U                    | S1U                    | EC           | EU               | OC         | OU             | MC         | MU             | CCSC           | CCSU               | YGC                | YGCT                   | FGC                | FGCT                   | GCT                |
| ------------------ | ------------------ | ---------------------- | ---------------------- | ------------ | ---------------- | ---------- | -------------- | ---------- | -------------- | -------------- | ------------------ | ------------------ | ---------------------- | ------------------ | ---------------------- | ------------------ |
| 第一个幸存区的大小 | 第二个幸存区的大小 | 第一个幸存区的使用大小 | 第二个幸存区的使用大小 | Eden区的大小 | Eden区的使用大小 | 老年代大小 | 老年代使用大小 | 方法区大小 | 方法区使用大小 | 压缩类空间大小 | 压缩类空间使用大小 | 年轻代垃圾回收次数 | 年轻代垃圾回收消耗时间 | 老年代垃圾回收次数 | 老年代垃圾回收消耗时间 | 垃圾回收消耗总时间 |

#### 堆内存统计 jstat -gccapacity
| NGCMN          | NGCMX          | NGC            | S0C              | S1C              | EC         | OGCMN          | OGCMX          | OGC            | OC             | MCMN           | MCMX           | MC                 | CCSMN              | CCSMX              | CCSC               | YGC          | FGC          |
| -------------- | -------------- | -------------- | ---------------- | ---------------- | ---------- | -------------- | -------------- | -------------- | -------------- | -------------- | -------------- | ------------------ | ------------------ | ------------------ | ------------------ | ------------ | ------------ |
| 新生代最小容量 | 新生代最大容量 | 当前新生代容量 | 第一个幸存区大小 | 第二个幸存区大小 | Eden区大小 | 老年代最小容量 | 老年代最大容量 | 当前老年代大小 | 当前老年代大小 | 最小元数据容量 | 最大元数据容量 | 当前元数据空间大小 | 最小压缩类空间大小 | 最大压缩类空间大小 | 当前压缩类空间大小 | 年轻代gc次数 | 老年代gc次数 |

#### 新生代垃圾回收统计 jstat -gcnew
| S0C              | S1C              | S0U                  | S1U                  | TT                     | MTT                        | DSS              | EC         | EU             | YGC                | YGCT                   |
| ---------------- | ---------------- | -------------------- | -------------------- | ---------------------- | -------------------------- | ---------------- | ---------- | -------------- | ------------------ | ---------------------- |
| 第一个幸存区大小 | 第二个幸存区大小 | 第一个幸存区使用大小 | 第二个幸存区使用大小 | 对象在新生代存活的次数 | 对象在新生代存活的最大次数 | 期望的幸存区大小 | Eden区大小 | Eden区使用大小 | 年轻代垃圾回收次数 | 年轻代垃圾回收消耗时间 |

#### 新生代内存统计 jstat -gcnewcapacity
| NGCMN          | NGCMX          | NGC            | S0CMX           | S0C             | S1CMX           | S1C             | ECMX           | EC             | YGC                | FGC            |
| -------------- | -------------- | -------------- | --------------- | --------------- | --------------- | --------------- | -------------- | -------------- | ------------------ | -------------- |
| 新生代最小容量 | 新生代最大容量 | 当前新生代容量 | 最大幸存1区大小 | 当前幸存1区大小 | 最大幸存2区大小 | 当前幸存2区大小 | 最大Eden区大小 | 当前Eden区大小 | 年轻代垃圾回收次数 | 老年代回收次数 |

#### 老年代垃圾回收统计 jstat -gcold
| MC         | MU             | CCSC           | CCSU               | OC         | OU             | YGC                | FGC                | FGCT                   | GCT                |
| ---------- | -------------- | -------------- | ------------------ | ---------- | -------------- | ------------------ | ------------------ | ---------------------- | ------------------ |
| 方法区大小 | 方法区使用大小 | 压缩类空间大小 | 压缩类空间使用大小 | 老年代大小 | 老年代使用大小 | 年轻代垃圾回收次数 | 老年代垃圾回收次数 | 老年代垃圾回收消耗时间 | 垃圾回收消耗总时间 |

#### 老年代内存统计 jstat -gcoldcapacity
| OGCMN          | OGCMX          | OGC            | OC         | YGC                | FGC                | FGCT                   | GCT                |
| -------------- | -------------- | -------------- | ---------- | ------------------ | ------------------ | ---------------------- | ------------------ |
| 老年代最小容量 | 老年代最大容量 | 当前老年代大小 | 老年代大小 | 年轻代垃圾回收次数 | 老年代垃圾回收次数 | 老年代垃圾回收消耗时间 | 垃圾回收消耗总时间 |

#### 元数据空间统计 jstat -gcmetacapacity
| MCMN           | MCMX           | MC                 | CCSMN              | CCSMX              | CCSC               | YGC                | FGC                | FGCT                   | GCT                |
| -------------- | -------------- | ------------------ | ------------------ | ------------------ | ------------------ | ------------------ | ------------------ | ---------------------- | ------------------ |
| 最小元数据容量 | 最大元数据容量 | 当前元数据空间大小 | 最小压缩类空间大小 | 最大压缩类空间大小 | 当前压缩类空间大小 | 年轻代垃圾回收次数 | 老年代垃圾回收次数 | 老年代垃圾回收消耗时间 | 垃圾回收消耗总时间 |

#### 总垃圾回收统计 jstat -gcutil
| S0                  | S1                  | E              | O              | M                | CCS          | YGC                | YGCT                   | FGC                | FGCT                   | GCT                |
| ------------------- | ------------------- | -------------- | -------------- | ---------------- | ------------ | ------------------ | ---------------------- | ------------------ | ---------------------- | ------------------ |
| 幸存1区当前使用比例 | 幸存2区当前使用比例 | Eden区使用比例 | 老年代使用比例 | 元数据区使用比例 | 压缩使用比例 | 年轻代垃圾回收次数 | 年轻代垃圾回收消耗时间 | 老年代垃圾回收次数 | 老年代垃圾回收消耗时间 | 垃圾回收消耗总时间 |

#### JVM编译方法统计 jstat -printcompilation
| Compiled           | Size                     | Type                   | Method     |
| ------------------ | ------------------------ | ---------------------- | ---------- |
| 最近编译方法的数量 | 最近编译方法的字节码数量 | 最近编译方法的编译类型 | 方法名标识 |